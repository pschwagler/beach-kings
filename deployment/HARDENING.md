# Backend Hardening — Deployment Guide

Changes made on the `feature/ps/placeholder-players` branch to harden against automated vulnerability scanners.

---

## What Changed (code)

| Change | Files |
|---|---|
| Docker ports bound to `127.0.0.1` | `docker-compose.yml` |
| Nginx scanner path blocking + rate limiting | 3 nginx configs in `deployment/` |
| CORS restricted to explicit origins | `apps/backend/api/main.py`, `.env.example` |
| Security response headers added | nginx configs |
| Railway references removed | `railway.json` (deleted), Dockerfiles, `entrypoint.sh`, etc. |

---

## Pre-Deploy

### 1. Add `ALLOWED_ORIGINS` to production `.env`

```bash
# SSH into server, edit .env
ALLOWED_ORIGINS=https://beachleaguevb.com,https://dev.beachleaguevb.com
```

If this variable is missing, CORS defaults to `http://localhost:3000` (safe but will block prod frontend).

---

## Deploy

### 2. Pull and restart Docker containers

```bash
cd ~/beach-kings  # or wherever the repo lives
git pull
docker compose up -d --build
```

The port binding change (`127.0.0.1:8000` instead of `0.0.0.0:8000`) takes effect on container restart.

### 3. Update Nginx configs on the server

```bash
# Copy HTTP config
sudo cp deployment/nginx/beachleaguevb.com.conf /etc/nginx/sites-available/beachleaguevb.com

# Copy dev config
sudo cp deployment/dev/nginx/dev.beachleaguevb.com.conf /etc/nginx/sites-available/dev.beachleaguevb.com.conf

# HTTPS: If SSL is already active, the live config was generated by setup-ssl.sh.
# You need to manually add these blocks to the LIVE HTTPS config
# (the template only applies on fresh SSL setup):
#
#   1. Add before the server block:
#      limit_req_zone $binary_remote_addr zone=global_https:10m rate=30r/s;
#
#   2. Add inside the server block, before location /api/:
#      limit_req zone=global_https burst=60 nodelay;
#
#      location ~* (\.php|\.env|\.git|/etc/passwd|/backup/|/bins?/|/vendor/|/wp-|/admin|/cgi-bin|/sdk|/webui|eval-stdin|\.aspx) {
#          return 444;
#      }
#
#   3. Update Referrer-Policy header to:
#      add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Test and reload
sudo nginx -t && sudo systemctl reload nginx
```

---

## Post-Deploy Verification

### 4. Confirm port 8000 is not externally reachable

From your local machine (not the server):

```bash
curl -v http://<server-public-ip>:8000
# Expected: Connection refused
```

### 5. Confirm scanner paths are blocked

```bash
curl -v https://beachleaguevb.com/vendor/phpunit/src/Util/PHP/eval-stdin.php
# Expected: Empty response / connection reset (nginx 444)

curl -v https://beachleaguevb.com/.env
# Expected: Same — connection reset
```

### 6. Confirm CORS is restricted

Open `https://beachleaguevb.com` in browser, open DevTools > Network tab, find any `/api/` request, and check response headers:

```
Access-Control-Allow-Origin: https://beachleaguevb.com
```

Should show your domain, **not** `*`.

---

## Cloudflare Setup (Recommended)

Not a code change — DNS/infrastructure config. Free tier is sufficient.

### 7. Create Cloudflare account and add domain

1. Go to https://dash.cloudflare.com and sign up
2. Click "Add a Site" > enter `beachleaguevb.com`
3. Select **Free** plan

### 8. Update nameservers

Cloudflare will show you two nameservers (e.g. `ada.ns.cloudflare.com`). Update these at your domain registrar (wherever you bought the domain).

DNS propagation takes up to 24 hours but usually ~1 hour.

### 9. Configure DNS records

In Cloudflare DNS settings:

| Type | Name | Content | Proxy |
|---|---|---|---|
| A | `@` | `<EC2 public IP>` | **Proxied** (orange cloud) |
| A | `dev` | `<EC2 public IP>` | **Proxied** (orange cloud) |
| CNAME | `www` | `beachleaguevb.com` | **Proxied** |

**Important:** The orange cloud (Proxied) hides your real server IP from scanners.

### 10. SSL settings

Go to SSL/TLS > Overview:
- Set mode to **Full (Strict)** (since we already have Let's Encrypt certs on the server)

### 11. Enable bot protection

- Go to Security > Bots > enable **Bot Fight Mode**
- Optionally enable "Under Attack" mode during active scan campaigns (Security > Settings)

### 12. Verify Cloudflare is active

```bash
dig beachleaguevb.com
# Should return Cloudflare IPs (104.x.x.x or 172.x.x.x), NOT your EC2 IP
```

---

## What This Doesn't Cover

- **Fail2ban**: Cloudflare + Nginx rate limiting covers this use case
- **WAF appliance**: Cloudflare free tier includes basic OWASP rules
- **IP allowlisting**: Too restrictive for a public web app
